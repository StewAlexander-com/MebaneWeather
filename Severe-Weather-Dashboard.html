<!--
  ==============================================================================
  Severe Weather Dashboard for Mebane, NC
  ==============================================================================
  
  This dashboard displays real-time severe weather threat assessments for the
  Mebane, NC area (Alamance County). It aggregates data from multiple sources:
  
  - Storm Prediction Center (SPC) outlooks for convective risk levels
  - National Weather Service (NWS) active alerts for Alamance County (NCZ023)
  - NWS Forecast Discussion (AFD) summaries from the Raleigh office (RAH)
  
  Features:
  - Threat level assessment with visual indicators (SAFE, MONITOR, CAUTION, WARNING)
  - Clickable panels linking to official NWS/SPC sources
  - Automatic updates every 15 minutes with 3-minute alert polling
  - Responsive design for mobile and desktop
  - Intelligent forecast discussion summarization highlighting severe weather hazards
  
  Location: Mebane, NC (36.096°N, -79.267°W)
  
  To customize for a different location, modify the LOCATION_CONFIG object
  in the Configuration Constants section (see LOCATION_CONFIG for details).
  ==============================================================================
-->
<div id="weather-dashboard-wrapper" style="
  position: relative; 
  margin: 20px auto; 
  max-width: 1000px;
  width: 95%;
  box-sizing: border-box;
">
  <div id="weather-dashboard-container" style="
    width: 100%; 
    background: #1a1a1a; 
    color: #e0e0e0; 
    font-family: 'Helvetica Neue', Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'; 
    border-radius: 12px; 
    padding: 20px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
    box-sizing: border-box;
  ">
    <div id="dashboard-title" style="
      width: 100%;
      background: linear-gradient(135deg, #8a6df2 0%, #6a11cb 55%, #5a0fbf 100%);
      color: #ffffff;
      text-align: center;
      font-weight: 700;
      font-size: 1.1em;
      letter-spacing: 0.3px;
      padding: 12px 12px 10px 12px;
      border-radius: 10px;
      margin: 0 0 14px 0;
      box-sizing: border-box;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
    ">
      <div style="font-size: 1.05em; font-weight: 700;">Storm Risk Dashboard</div>
      <div style="font-size: 0.78em; font-weight: 500; opacity: 0.9; margin-top: 2px;">Updates every 15 minutes (alerts may trigger faster updates)</div>
    </div>
    <!--
      Dashboard Panels Container
      Two-column grid layout displaying threat assessment and alerts/forecast.
      Responsive: switches to single column on mobile devices.
    -->
    <div id="dashboard-panels" style="
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px; 
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    ">
      <!-- 
        Threat Level Panel - CLICKABLE
        Displays current severe weather threat assessment based on SPC outlooks
        and active warnings. Clicking opens SPC outlook page in new tab.
        Status values: SAFE, MONITOR, CAUTION, WARNING
      -->
      <div id="threat-panel" style="
        background: #2d2d2d; 
        padding: 25px; 
        border-radius: 8px; 
        transition: all 0.3s ease;
        box-sizing: border-box;
        cursor: pointer;
        border: 2px solid transparent;
      " onclick="window.open('https://www.spc.noaa.gov/products/outlook/', '_blank')" 
         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.4)'; this.style.borderColor='#4fc3f7';" 
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='transparent';">
        <h3 style="margin: 0 0 15px 0; color: #4fc3f7; font-size: 1.4em; font-weight: 600;">
          Current Threat Level 
          <span style="font-size: 0.7em; opacity: 0.8; margin-left: 8px;">↗ Click for SPC Details</span>
        </h3>
        <div id="threat-content" style="display: flex; align-items: center; gap: 20px; box-sizing: border-box;">
          <div id="threat-icon" role="img" aria-label="Safe status" style="
            font-size: 3.5em !important; 
            font-family: 'Apple Color Emoji','Segoe UI Emoji','Noto Color Emoji','Segoe UI Symbol','Helvetica Neue',Arial,sans-serif !important; 
            display: inline !important; 
            width: 80px !important; 
            text-align: center !important; 
            line-height: 1 !important; 
            vertical-align: middle !important; 
            color: inherit !important;
            filter: none !important;
            background: none !important;
            border: none !important;
            padding: 0 !important;
          ">✅</div>
          <div style="flex: 1; box-sizing: border-box;">
            <div id="threat-status" style="font-size: 2em; font-weight: 700; margin-bottom: 5px; color: #4CAF50;">SAFE</div>
            <div id="threat-description" style="opacity: 0.9; font-size: 1em; margin-bottom: 8px;">No severe weather expected</div>
            <div id="spc-data" style="font-size: 0.8em; opacity: 0.8; background: #373737; padding: 6px; border-radius: 4px;">SPC: Loading threat assessment...</div>
            <div id="threat-updated" style="font-size: 0.75em; opacity: 0.7; margin-top: 6px;">Updated just now</div>
          </div>
        </div>
      </div>

      <!-- 
        Alerts & Forecast Panel - MULTIPLE CLICKABLE SECTIONS
        Contains two subsections:
        1. Alamance County Alerts - Active NWS warnings/watches/advisories
        2. NWS Forecast Discussion - Intelligent summary of AFD highlighting severe weather
        Each subsection is clickable and opens relevant NWS pages in new tabs.
      -->
      <div id="alerts-panel" style="
        background: #2d2d2d; 
        padding: 25px; 
        border-radius: 8px;
        box-sizing: border-box;
      ">
        <h3 style="margin: 0 0 15px 0; color: #ff7043; font-size: 1.4em; font-weight: 600;">Active Alerts & Forecast</h3>
        
        <!-- Alamance County Alerts Section - CLICKABLE -->
        <div style="margin-bottom: 12px; box-sizing: border-box;">
          <div style="font-size: 0.9em; font-weight: 600; color: #4fc3f7; margin-bottom: 6px;">
            Alamance County Alerts: 
            <span style="font-size: 0.7em; opacity: 0.8;">↗ Click for Current Alerts</span>
          </div>
          <div id="alamance-alerts" style="
            background: #373737; 
            padding: 8px; 
            border-radius: 4px; 
            font-size: 0.85em; 
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
          " id="alamance-alerts-click"
             onmouseover="this.style.backgroundColor='#4a4a4a'; this.style.borderColor='#4fc3f7';" 
             onmouseout="this.style.backgroundColor='#373737'; this.style.borderColor='transparent';">
            <span style="color: #4fc3f7;">●</span> No active severe weather alerts
          </div>
          <div id="alerts-updated" style="font-size: 0.75em; opacity: 0.7; margin-top: 6px;">Checked just now</div>
        </div>
        
        <!-- NWS Forecast Discussion Section - CLICKABLE -->
        <div style="box-sizing: border-box;">
          <div style="font-size: 0.9em; font-weight: 600; color: #ff7043; margin-bottom: 6px;">
            NWS Forecast Discussion: 
            <span style="font-size: 0.7em; opacity: 0.8;">↗ Click for Full AFD</span>
          </div>
          <div id="afd-content" style="
            background: #373737; 
            padding: 8px; 
            border-radius: 4px; 
            font-size: 0.8em; 
            max-height: 80px; 
            overflow-y: auto; 
            line-height: 1.3; 
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
          " id="afd-content-click"
             onmouseover="this.style.backgroundColor='#4a4a4a'; this.style.borderColor='#ff7043';" 
             onmouseout="this.style.backgroundColor='#373737'; this.style.borderColor='transparent';">
            Loading forecast discussion...
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 
  ============================================================================
  CSS Styles
  ============================================================================
  Provides responsive design rules and ensures emoji/icon visibility across
  different browsers and devices. Includes mobile breakpoints for optimal
  viewing on small screens.
  ============================================================================
-->
<style type="text/css">
#weather-dashboard-wrapper {
  box-sizing: border-box !important;
}
#weather-dashboard-wrapper *,
#weather-dashboard-wrapper *:before,
#weather-dashboard-wrapper *:after {
  box-sizing: border-box !important;
}

/* Responsive rules */
@media (max-width: 768px) {
  #weather-dashboard-wrapper {
    width: 98% !important;
    margin: 15px auto !important;
  }
  #weather-dashboard-container {
    padding: 15px !important;
  }
  #dashboard-title {
    font-size: 1em !important;
    padding: 10px 10px 8px 10px !important;
    border-radius: 8px !important;
    margin-bottom: 12px !important;
  }
  #dashboard-panels {
    grid-template-columns: 1fr !important;
    gap: 15px !important;
  }
  #threat-panel, #alerts-panel {
    padding: 20px !important;
  }
  #threat-content {
    flex-direction: column !important;
    text-align: center !important;
    gap: 15px !important;
  }
  #threat-icon {
    width: auto !important;
    font-size: 2.5em !important;
  }
  #threat-status {
    font-size: 1.5em !important;
  }
}

@media (max-width: 480px) {
  #weather-dashboard-wrapper {
    width: 98% !important;
    margin: 10px auto !important;
  }
  #weather-dashboard-container {
    padding: 12px !important;
    border-radius: 8px !important;
  }
  #threat-panel h3, #alerts-panel h3 {
    font-size: 1.2em !important;
  }
}

#weather-dashboard-wrapper #threat-icon,
#weather-dashboard-wrapper [id^="threat-icon"] {
  font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', 'Helvetica Neue', Arial, sans-serif !important;
  font-size: 3.5em !important;
  display: inline !important;
  width: 80px !important;
  text-align: center !important;
  line-height: 1 !important;
  vertical-align: middle !important;
  color: inherit !important;
  filter: none !important;
  background: none !important;
  border: none !important;
  padding: 0 !important;
}
#weather-dashboard-wrapper [id^="threat-icon"] span,
#weather-dashboard-wrapper [id^="threat-icon"] img, 
#weather-dashboard-wrapper [id^="threat-icon"] svg {
  display: inline !important;
  font-family: inherit !important;
  font-size: inherit !important;
  line-height: 1 !important;
  color: inherit !important;
  background: none !important;
  border: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
  filter: none !important;
}
#weather-dashboard-wrapper #threat-icon:empty::before {
  content: '⚠️';
}
</style>

<!-- ============================================================================
  JavaScript: Dashboard Functionality
  ============================================================================
  Self-contained module that fetches weather data and updates the dashboard UI.
  Uses IIFE pattern to avoid global namespace pollution.
  ============================================================================ -->
<script type="text/javascript">
(function() {
  'use strict';
  
  // Prevent multiple initializations if script is loaded multiple times
  if (window.correctedWeatherDashboard) {
    return;
  }
  window.correctedWeatherDashboard = true;

  // ==========================================================================
  // Configuration Constants
  // ==========================================================================
  
  // ==========================================================================
  // LOCATION CONFIGURATION - Modify these values to change dashboard location
  // ==========================================================================
  
  /**
   * Location Configuration Object
   * 
   * To customize for a different location, update all of the following:
   * 
   * @property {Object} coords - Geographic coordinates (latitude, longitude)
   * @property {string} nwsZone - NWS zone code for alerts (format: STATEZONENUMBER)
   *                              Find your zone: https://forecast.weather.gov/MapClick.php
   * @property {string} stateCode - Two-letter state code for fallback alerts (e.g., 'NC', 'TX', 'CA')
   * @property {string} nwsOffice - NWS office identifier for forecast discussions (e.g., 'RAH', 'OUN', 'SFO')
   *                                 Find your office: https://www.weather.gov/organization.php
   * @property {string} locationName - Display name for the location
   */
  const LOCATION_CONFIG = {
    coords: { lat: 36.096, lng: -79.267 },  // Mebane, NC coordinates
    nwsZone: 'NCZ023',                       // Alamance County, NC zone code
    stateCode: 'NC',                         // North Carolina state code
    nwsOffice: 'RAH',                        // Raleigh, NC NWS office
    locationName: 'Mebane, NC'               // Location display name
  };
  
  // Extract individual values for backward compatibility and easy access
  const coords = LOCATION_CONFIG.coords;
  const NWS_ZONE = LOCATION_CONFIG.nwsZone;
  const STATE_CODE = LOCATION_CONFIG.stateCode;
  const NWS_OFFICE = LOCATION_CONFIG.nwsOffice;
  
  /**
   * Dashboard update interval in milliseconds (15 minutes)
   * Full dashboard refresh rate
   */
  const updateInterval = 900000;
  
  /**
   * Timestamp of last full dashboard update
   * Used to throttle updates and prevent excessive API calls
   */
  let lastUpdate = 0;
  
  /**
   * Current alert status state tracking
   * Values: 'no-alerts', 'active-alerts', 'error'
   */
  let currentAlertStatus = 'no-alerts';
  let currentAlertDisplay = 'No active severe weather alerts';
  let lastAlertsChecked = 0;

  /**
   * Winter weather detection state tracking
   * Values: 'none', 'advisory', 'warning'
   */
  let winterWeatherStatus = 'none';

  /**
   * SPC (Storm Prediction Center) risk category mappings
   * Maps SPC risk codes to human-readable descriptions
   * @constant {Object<string, string>}
   */
  const spcCategories = {
    'TSTM': 'General Thunderstorms, No Severe Weather Expected',
    'MRGL': 'Marginal Risk - Isolated severe storms possible',
    'SLGT': 'Slight Risk - Scattered severe storms likely', 
    'ENH': 'Enhanced Risk - Numerous severe storms expected',
    'MDT': 'Moderate Risk - Widespread severe storms likely',
    'HIGH': 'High Risk - Major severe weather outbreak expected'
  };

  // ==========================================================================
  // SPC (Storm Prediction Center) Risk Assessment Functions
  // ==========================================================================
  
  /**
   * Checks the current SPC convective outlook risk level for the configured location.
   * Wrapper function with error handling that calls the API implementation.
   * 
   * @returns {Promise<string|null>} SPC risk code (TSTM, MRGL, SLGT, ENH, MDT, HIGH)
   *                                 or null if unable to determine or API error
   */
  async function checkSPCRisk() {
    try {
      return await checkSPCRiskFromAPI();
    } catch (error) {
      console.log('SPC API failed:', error);
      return null;
    }
  }

  /**
   * Fetches SPC convective outlook risk level from NOAA ArcGIS REST API.
   * Performs a spatial point-in-polygon query to find which outlook polygon
   * contains the configured coordinates. Uses timeout protection and validates response.
   * 
   * @returns {Promise<string|null>} SPC risk code from codeMap or null if no match/error
   * @private
   */
  async function checkSPCRiskFromAPI() {
    try {
      const baseUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/1/query';
      const params = new URLSearchParams({
        'f': 'json',
        'geometry': `${coords.lng},${coords.lat}`,
        'geometryType': 'esriGeometryPoint',
        'spatialRel': 'esriSpatialRelIntersects',
        'outFields': 'dn,valid,expire',
        'returnGeometry': 'false'
      });

      // Use fetchJSON for timeout protection and error handling
      const data = await fetchJSON(`${baseUrl}?${params}`, 10000);
      
      // Validate response structure
      if (!data || typeof data !== 'object') {
        console.warn('SPC API: Invalid response structure');
        return null;
      }
      
      if (data.features && Array.isArray(data.features) && data.features.length > 0) {
        const feature = data.features[0];
        if (feature && feature.attributes && typeof feature.attributes.dn !== 'undefined') {
          const dnValue = feature.attributes.dn;
          // Map SPC outlook DN (day number) values to risk category codes
          // DN values correspond to outlook risk levels from SPC's classification system
          const codeMap = { 2: 'TSTM', 3: 'MRGL', 4: 'SLGT', 5: 'ENH', 6: 'MDT', 8: 'HIGH' };
          return codeMap[dnValue] || null;
        }
      }
      return null;
    } catch (error) {
      console.error('SPC API fetch error:', error.message);
      throw error; // Re-throw to be caught by wrapper
    }
  }

  /**
   * Updates the SPC information display in the threat panel.
   * Fetches current risk level and displays formatted description.
   * 
   * @returns {Promise<string|null>} SPC risk code or null on error
   */
  async function updateSPCInfo() {
    try {
      const spcRiskLevel = await checkSPCRisk();
      let spcInfo = "No thunderstorms expected";
      if (spcRiskLevel && spcCategories[spcRiskLevel]) {
        spcInfo = spcCategories[spcRiskLevel];
      }
      updateElement('spc-data', `SPC: ${spcInfo}`, 'innerHTML');
      return spcRiskLevel;
    } catch (error) {
      console.error('SPC info update error:', error);
      updateElement('spc-data', 'SPC: Data temporarily unavailable', 'innerHTML');
      return null;
    }
  }

  // ==========================================================================
  // Utility Functions with Robust Error Handling
  // ==========================================================================
  
  /**
   * Error Handling Strategy:
   * 
   * 1. Timeout Protection: All external API calls use AbortController with configurable timeouts
   * 2. Response Validation: Validate JSON structure before accessing properties
   * 3. Fallback Mechanisms: Multiple fallback strategies for critical data sources
   *    - Alerts: Zone → Statewide
   *    - AFD: API → HTML scrape
   * 4. Graceful Degradation: Dashboard remains functional even if some data sources fail
   * 5. Error Logging: Detailed console logging for debugging while maintaining user experience
   * 6. Network Error Detection: Specific handling for network failures vs API errors
   * 7. JSON Parse Protection: Separate JSON parsing with error handling
   */
  
  
  /**
   * Fetches JSON data from a URL with configurable timeout and robust error handling.
   * Uses AbortController to cancel request if timeout is exceeded.
   * 
   * @param {string} url - The URL to fetch
   * @param {number} timeoutMs - Timeout in milliseconds (default: 8000)
   * @returns {Promise<Object>} Parsed JSON response
   * @throws {Error} If HTTP error, timeout, network error, or JSON parse error occurs
   */
  async function fetchJSON(url, timeoutMs = 8000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeoutMs);
    try {
      const resp = await fetch(url, { signal: controller.signal });
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}: ${resp.statusText || 'Request failed'}`);
      }
      const contentType = resp.headers.get('content-type');
      if (contentType && !contentType.includes('application/json')) {
        console.warn(`Unexpected content-type: ${contentType} for URL: ${url}`);
      }
      const text = await resp.text();
      if (!text || text.trim().length === 0) {
        throw new Error('Empty response received');
      }
      try {
        return JSON.parse(text);
      } catch (parseError) {
        throw new Error(`JSON parse error: ${parseError.message}`);
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        throw new Error(`Request timeout after ${timeoutMs}ms`);
      }
      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        throw new Error('Network error: Unable to reach server');
      }
      throw error;
    } finally {
      clearTimeout(id);
    }
  }

  /**
   * Fetches text data from a URL with configurable timeout and error handling.
   * 
   * @param {string} url - The URL to fetch
   * @param {number} timeoutMs - Timeout in milliseconds (default: 8000)
   * @returns {Promise<string>} Response text
   * @throws {Error} If HTTP error, timeout, or network error occurs
   */
  async function fetchText(url, timeoutMs = 8000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeoutMs);
    try {
      const resp = await fetch(url, { signal: controller.signal });
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}: ${resp.statusText || 'Request failed'}`);
      }
      return await resp.text();
    } catch (error) {
      if (error.name === 'AbortError') {
        throw new Error(`Request timeout after ${timeoutMs}ms`);
      }
      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        throw new Error('Network error: Unable to reach server');
      }
      throw error;
    } finally {
      clearTimeout(id);
    }
  }

  // ==========================================================================
  // Winter Weather Detection
  // ==========================================================================
  
  /**
   * Winter weather synonym dictionary for comprehensive detection.
   * Includes NWS official alert types and common weather terminology.
   * 
   * @constant {Object<string, Array<string>>}
   */
  const WINTER_WEATHER_SYNONYMS = {
    // Official NWS alert types - comprehensive list
    alerts: [
      // Advisories
      'winter weather advisory',
      'freezing rain advisory',
      'snow advisory',
      'wind chill advisory',
      'frost advisory',
      'lake effect snow advisory',
      'winter weather statement',
      // Warnings
      'winter storm warning',
      'winter weather warning',
      'ice storm warning',
      'blizzard warning',
      'wind chill warning',
      'freeze warning',
      'freezing rain warning',
      'snow squall warning',
      'lake effect snow warning',
      'extreme cold warning',
      'hard freeze warning',
      // Watches
      'winter storm watch',
      'ice storm watch',
      'blizzard watch',
      'wind chill watch',
      'extreme cold watch',
      'freeze watch',
      'freezing rain watch',
      'lake effect snow watch'
    ],
    // Weather phenomena keywords - comprehensive coverage
    phenomena: [
      // Snow terms
      'snow', 'snowfall', 'snowing', 'snowstorm', 'snowfall',
      'snow squall', 'snow shower', 'snow flurries', 'flurries',
      'blowing snow', 'drifting snow', 'snowdrift',
      'lake effect snow', 'upslope snow',
      'accumulating snow', 'snow accumulation', 'snow totals',
      'snowfall rates', 'heavy snow', 'significant snow',
      // Ice terms
      'ice', 'icing', 'black ice', 'glaze ice',
      'freezing rain', 'freezing drizzle', 'freezing fog',
      'ice accumulation', 'ice buildup', 'ice storm',
      'ice formation', 'ice coating',
      // Mixed precipitation
      'sleet', 'sleeting', 'sleet pellets',
      'wintry', 'wintry mix', 'winter precipitation',
      'freezing precipitation', 'mixed precipitation',
      // Cold conditions
      'freezing temperatures', 'below freezing',
      'wind chill', 'windchill', 'wind chill factor',
      'extreme cold', 'bitter cold', 'dangerous cold',
      'hard freeze', 'freeze', 'frost',
      // Visibility/conditions
      'blizzard', 'whiteout', 'near-zero visibility',
      'winter conditions', 'winter weather',
      'hazardous winter weather', 'winter storm'
    ],
    // Timing/severity indicators
    severity: [
      'imminent', 'occurring', 'expected',
      'developing', 'arriving', 'approaching',
      'significant', 'hazardous', 'dangerous'
    ]
  };

  /**
   * Checks if an alert event name indicates winter weather.
   * Uses comprehensive synonym matching to detect various winter weather alerts.
   * 
   * @param {string} eventName - Alert event name (case-insensitive)
   * @returns {boolean} True if event is winter weather related
   */
  function isWinterWeatherAlert(eventName) {
    if (!eventName || typeof eventName !== 'string') {
      return false;
    }
    const eventLower = eventName.toLowerCase();
    return WINTER_WEATHER_SYNONYMS.alerts.some(alert => eventLower.includes(alert));
  }

  /**
   * Detects winter weather from alert data.
   * Checks for winter weather advisories and warnings in active alerts.
   * 
   * @param {Array} alerts - Array of alert objects from NWS API
   * @returns {Object} Object with status ('none'|'advisory'|'warning') and details
   */
  function detectWinterWeatherFromAlerts(alerts) {
    if (!alerts || !Array.isArray(alerts) || alerts.length === 0) {
      return { status: 'none', hasAdvisory: false, hasWarning: false };
    }

    let hasWarning = false;
    let hasAdvisory = false;

    for (const alert of alerts) {
      if (!alert || typeof alert !== 'object' || !alert.properties) {
        continue;
      }
      
      const event = (alert.properties.event && typeof alert.properties.event === 'string')
                   ? alert.properties.event
                   : '';
      
      if (!isWinterWeatherAlert(event)) {
        continue;
      }

      const eventLower = event.toLowerCase();
      const severity = (alert.properties.severity && typeof alert.properties.severity === 'string')
                      ? alert.properties.severity.toLowerCase()
                      : '';

      // Check for warnings (highest priority) - comprehensive detection
      // Look for "warning" keyword but exclude "watch" and "advisory" variations
      if (eventLower.includes('warning') && 
          !eventLower.includes('watch') && 
          !eventLower.includes('advisory') &&
          !eventLower.includes('statement')) {
        hasWarning = true;
        console.log(`[Winter Weather] WARNING detected: "${event}"`);
      }
      // Check for advisories (lower priority)
      // Includes advisory, watch (unless severe), and statements
      else if (eventLower.includes('advisory') || 
               eventLower.includes('statement') ||
               (eventLower.includes('watch') && severity !== 'severe')) {
        hasAdvisory = true;
        console.log(`[Winter Weather] ADVISORY/WATCH detected: "${event}"`);
      }
    }

    if (hasWarning) {
      console.log(`[Winter Weather] Status determined: WARNING (has ${hasWarning ? 'warning' : ''}, ${hasAdvisory ? 'advisory' : ''})`);
      return { status: 'warning', hasAdvisory: true, hasWarning: true };
    } else if (hasAdvisory) {
      console.log(`[Winter Weather] Status determined: ADVISORY`);
      return { status: 'advisory', hasAdvisory: true, hasWarning: false };
    }

    return { status: 'none', hasAdvisory: false, hasWarning: false };
  }

  /**
   * Checks forecast discussion text for winter weather keywords.
   * Uses comprehensive synonym matching to detect winter weather mentions.
   * 
   * @param {string} text - Forecast discussion text (case-insensitive)
   * @returns {Object} Object with detected status and confidence
   */
  function detectWinterWeatherInText(text) {
    if (!text || typeof text !== 'string') {
      return { status: 'none', confidence: 0 };
    }

    const textLower = text.toLowerCase();
    let score = 0;
    let hasWarningTerms = false;
    let hasAdvisoryTerms = false;

    // Check for winter weather phenomena
    for (const term of WINTER_WEATHER_SYNONYMS.phenomena) {
      if (textLower.includes(term)) {
        score += 2;
      }
    }

    // Check for severity/timing indicators
    for (const term of WINTER_WEATHER_SYNONYMS.severity) {
      if (textLower.includes(term)) {
        score += 1;
        if (term === 'imminent' || term === 'occurring') {
          hasWarningTerms = true;
        }
      }
    }

    // Check for official alert terminology in text (higher weight for official terms)
    for (const alert of WINTER_WEATHER_SYNONYMS.alerts) {
      if (textLower.includes(alert)) {
        score += 3;
        // Check for warning terms (higher priority)
        if (alert.includes('warning') && !alert.includes('watch') && !alert.includes('advisory')) {
          hasWarningTerms = true;
        } 
        // Check for advisory/watch/statement terms
        else if (alert.includes('advisory') || alert.includes('watch') || alert.includes('statement')) {
          hasAdvisoryTerms = true;
        }
      }
    }

    // Determine status based on score and indicators
    if (score >= 5) {
      // Check for winter weather warning terms (comprehensive detection)
      const warningPatterns = [
        'winter storm warning', 'winter weather warning', 'ice storm warning',
        'blizzard warning', 'freezing rain warning', 'snow squall warning',
        'wind chill warning', 'extreme cold warning'
      ];
      const hasWarningPattern = warningPatterns.some(pattern => textLower.includes(pattern));
      
      if (hasWarningTerms || hasWarningPattern) {
        console.log('[Winter Weather] Text detection: WARNING status');
        return { status: 'warning', confidence: Math.min(score, 10) };
      } 
      // Check for advisory/watch/statement terms
      else if (hasAdvisoryTerms || 
               textLower.includes('winter weather advisory') ||
               textLower.includes('winter storm watch') ||
               textLower.includes('winter weather statement')) {
        console.log('[Winter Weather] Text detection: ADVISORY status');
        return { status: 'advisory', confidence: Math.min(score, 8) };
      } else {
        console.log('[Winter Weather] Text detection: ADVISORY status (generic winter weather)');
        return { status: 'advisory', confidence: Math.min(score, 6) };
      }
    }

    return { status: 'none', confidence: 0 };
  }

  // ==========================================================================
  // NWS Alert Functions
  // ==========================================================================
  
  /**
   * Fetches and displays active weather alerts for Alamance County (NCZ023).
   * Uses a two-tier fallback strategy: first tries zone-specific alerts,
   * then falls back to statewide NC alerts if zone query fails.
   * 
   * Filters alerts to show only warnings, watches, and advisories with
   * severe/moderate/minor severity levels.
   * 
   * Also detects and tracks winter weather status from alerts.
   * 
   * @returns {Promise<boolean>} True if active warnings (not watches/advisories) exist,
   *                            false otherwise or on error
   */
  async function updateLocalAlertsAndGetStatus() {
    try {
      // Primary: zone-specific alerts; Fallback: statewide alerts
      let data = null;
      let lastError = null;
      
      // Try zone-specific alerts first
      try {
        data = await fetchJSON(`https://api.weather.gov/alerts/active?zone=${NWS_ZONE}`, 8000);
        // Validate response structure
        if (data && typeof data === 'object' && Array.isArray(data.features)) {
          // Success - use zone-specific data
        } else {
          throw new Error('Invalid zone alert response structure');
        }
      } catch (e) {
        lastError = e;
        console.log(`Zone-specific alerts unavailable, trying statewide fallback: ${e.message}`);
        
        // Fallback to statewide alerts
        try {
          data = await fetchJSON(`https://api.weather.gov/alerts/active?area=${STATE_CODE}`, 8000);
          // Validate response structure
          if (!data || typeof data !== 'object' || !Array.isArray(data.features)) {
            throw new Error('Invalid statewide alert response structure');
          }
        } catch (fallbackError) {
          lastError = fallbackError;
          console.error('Both zone and statewide alert queries failed:', fallbackError.message);
          throw new Error(`Alert API unavailable: ${fallbackError.message}`);
        }
      }
      
      if (data && data.features && Array.isArray(data.features) && data.features.length > 0) {
        // Detect winter weather from alerts
        const winterWeather = detectWinterWeatherFromAlerts(data.features);
        const previousWinterStatus = winterWeatherStatus;
        winterWeatherStatus = winterWeather.status;
        
        // Debug: Log winter weather detection
        if (winterWeatherStatus !== 'none') {
          console.log(`Winter weather detected: ${winterWeatherStatus} (was: ${previousWinterStatus})`);
        }
        
        // Filter alerts to show only warnings/watches/advisories with valid severity
        // Excludes informational statements and other non-actionable alerts
        // Validates alert structure before processing
        const displayAlerts = data.features.filter(alert => {
          // Validate alert structure
          if (!alert || typeof alert !== 'object' || !alert.properties) {
            return false;
          }
          const properties = alert.properties;
          const event = (properties.event && typeof properties.event === 'string') 
                       ? properties.event.toLowerCase() 
                       : '';
          const severity = (properties.severity && typeof properties.severity === 'string') 
                          ? properties.severity.toLowerCase() 
                          : '';
          return (event.includes('warning') || event.includes('watch') || 
                  event.includes('advisory')) && 
                 (severity === 'severe' || severity === 'moderate' || severity === 'minor');
        });
        // Separate warnings (highest priority) from watches/advisories
        // Used to determine if threat level should be WARNING vs CAUTION/MONITOR
        const warningAlerts = data.features.filter(alert => {
          // Validate alert structure
          if (!alert || typeof alert !== 'object' || !alert.properties) {
            return false;
          }
          const event = (alert.properties.event && typeof alert.properties.event === 'string')
                       ? alert.properties.event.toLowerCase()
                       : '';
          return event.includes('warning') && 
                 !event.includes('watch') && !event.includes('advisory');
        });
        if (displayAlerts.length > 0) {
          const alertsHtml = displayAlerts.slice(0, 3).map(alert => {
            // Validate alert structure before accessing properties
            if (!alert || !alert.properties) {
              return '<span style="color: #4fc3f7;">●</span> Weather Alert';
            }
            const event = (alert.properties.event && typeof alert.properties.event === 'string')
                         ? alert.properties.event
                         : 'Weather Alert';
            let color = '#4fc3f7';
            const eventLower = event.toLowerCase();
            if (eventLower.includes('warning')) {
              color = '#f44336';
            } else if (eventLower.includes('watch')) {
              color = '#ff9800';
            } else if (eventLower.includes('advisory')) {
              color = '#ffeb3b';
            }
            // Escape HTML in event names for safety
            const safeEvent = event.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `<span style="color: ${color};">●</span> ${safeEvent}`;
          }).join('<br>');
          updateElement('alamance-alerts', alertsHtml, 'innerHTML');
          currentAlertStatus = 'active-alerts';
          currentAlertDisplay = alertsHtml;
          const updatedEl = document.getElementById('alerts-updated');
          if (updatedEl) {
            const d = new Date();
            const ts = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            updatedEl.textContent = `Checked ${ts}`;
          }
          lastAlertsChecked = Date.now();
          return warningAlerts.length > 0;
        }
      }
      // Reset winter weather status if no alerts found
      if (!data || !data.features || data.features.length === 0) {
        winterWeatherStatus = 'none';
      }
      
      const noAlertsHtml = '<span style="color: #4fc3f7;">●</span> No active severe weather alerts';
      updateElement('alamance-alerts', noAlertsHtml, 'innerHTML');
      currentAlertStatus = 'no-alerts';
      currentAlertDisplay = noAlertsHtml;
      const updatedEl = document.getElementById('alerts-updated');
      if (updatedEl) {
        const d = new Date();
        const ts = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        updatedEl.textContent = `Checked ${ts}`;
      }
      lastAlertsChecked = Date.now();
      return false;
    } catch (error) {
      console.error('Local alerts update failed:', error);
      const errorHtml = '<span style="color: #ff7043;">●</span> Alert system temporarily unavailable';
      updateElement('alamance-alerts', errorHtml, 'innerHTML');
      currentAlertStatus = 'error';
      currentAlertDisplay = errorHtml;
      const updatedEl = document.getElementById('alerts-updated');
      if (updatedEl) {
        const d = new Date();
        const ts = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        updatedEl.textContent = `Checked ${ts}`;
      }
      lastAlertsChecked = Date.now();
      return false;
    }
  }

  // ==========================================================================
  // Main Dashboard Update Function
  // ==========================================================================
  
  /**
   * Main dashboard update function that orchestrates all data fetching and UI updates.
   * 
   * Updates threat level based on:
   * 1. Active warnings (highest priority) -> WARNING status
   *    - Winter weather warnings -> "Winter Precipitation Imminent and/or Occurring"
   * 2. Winter weather advisories -> MONITOR status with "Monitor for Winter Conditions"
   * 3. SPC enhanced/moderate/high risk -> CAUTION status
   * 4. SPC marginal/slight risk -> MONITOR status
   * 5. No threats -> SAFE status
   * 
   * Checks both NWS alerts and forecast discussion for winter weather indicators.
   * Respects updateInterval throttling to prevent excessive API calls.
   * Also triggers forecast discussion update.
   * 
   * @returns {Promise<void>}
   */
  async function updateDashboard() {
    try {
      const now = Date.now();
      // Throttle updates: skip if less than updateInterval has passed
      if (now - lastUpdate < updateInterval) {
        return;
      }
      
      // Fetch data with independent error handling - one failure doesn't block others
      let hasActiveWarnings = false;
      let spcRiskLevel = null;
      
      try {
        hasActiveWarnings = await updateLocalAlertsAndGetStatus();
      } catch (error) {
        console.error('Alert update failed, continuing with other data:', error.message);
        // Continue - alerts error already displayed in alert panel
      }
      
      try {
        spcRiskLevel = await updateSPCInfo();
      } catch (error) {
        console.error('SPC info update failed, continuing with alerts data:', error.message);
        // Continue - SPC error already displayed in threat panel
      }
      
      // Check forecast discussion for winter weather if not already detected from alerts
      // This happens before threat level calculation so winter weather can be considered
      // Only check if alerts haven't already found winter weather (alerts are primary source)
      if (winterWeatherStatus === 'none') {
        try {
          await checkForecastDiscussionForWinterWeather();
        } catch (error) {
          console.log('Winter weather detection from forecast discussion skipped:', error.message);
          // Continue - not critical, alerts are primary source
        }
      }
      
      // Determine threat level using priority hierarchy (highest to lowest):
      let threatLevel = 'SAFE';
      let threatColor = '#4CAF50';
      let description = 'No severe weather expected';
      let icon = '✅';

      // Priority 1: Active warnings override all other indicators
      if (hasActiveWarnings) {
        // Check for winter weather warnings specifically
        if (winterWeatherStatus === 'warning') {
          threatLevel = 'WARNING';
          threatColor = '#f44336';
          description = 'Winter Precipitation Imminent and/or Occurring';
          icon = '⚠️';
          console.log('[Threat Level] Set to WARNING due to winter weather warning');
        } else {
          threatLevel = 'WARNING';
          threatColor = '#f44336';
          description = 'Active weather warnings in effect - follow official guidance';
          icon = '⚠️';
        }
      }
      // Priority 1a: Winter weather advisory (high priority, but not as urgent as warnings)
      else if (winterWeatherStatus === 'advisory') {
        threatLevel = 'MONITOR';
        threatColor = '#FFEB3B';
        description = 'Monitor for Winter Conditions';
        icon = '❄️';
        console.log('Threat level set to MONITOR due to winter weather advisory');
      }
      // Priority 2: Enhanced/Moderate/High SPC risk levels
      else if (spcRiskLevel && ['ENH', 'MDT', 'HIGH'].includes(spcRiskLevel)) {
        threatLevel = 'CAUTION';
        threatColor = '#ff9800';
        description = 'Elevated severe weather risk - stay alert';
        icon = '⚡';
      }
      // Priority 3: Marginal/Slight SPC risk levels
      else if (spcRiskLevel && ['MRGL', 'SLGT'].includes(spcRiskLevel)) {
        threatLevel = 'MONITOR';
        threatColor = '#FFEB3B';
        description = 'Monitor conditions for potential development';
        icon = '□';
      }
      // Default: SAFE (no active threats)

      updateElement('threat-status', threatLevel, 'textContent');
      updateElement('threat-status', threatColor, 'color');
      updateElement('threat-description', description, 'textContent');
      updateElement('threat-icon', icon, 'textContent');
      const iconEl = document.getElementById('threat-icon');
      if (iconEl) {
        iconEl.setAttribute('aria-label', `${threatLevel} status`);
      }
      const updatedEl = document.getElementById('threat-updated');
      if (updatedEl) {
        const d = new Date();
        const ts = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        updatedEl.textContent = `Updated ${ts}`;
      }
      lastUpdate = now;

    } catch (error) {
      console.error('Weather dashboard update error:', error);
      updateElement('threat-status', 'SAFE', 'textContent');
      updateElement('threat-status', '#4CAF50', 'color');
      updateElement('threat-description', 'Weather data temporarily unavailable', 'textContent');
      updateElement('threat-icon', '✅', 'textContent');
    }
    
    // Update forecast discussion independently - don't let errors here block dashboard
    try {
      await updateForecastDiscussion();
    } catch (error) {
      console.error('Forecast discussion update failed:', error.message);
      // Error already handled in updateForecastDiscussion - continue silently
    }
  }

  /**
   * Safely updates a DOM element's property or style.
   * Helper function with error handling to prevent dashboard crashes
   * if an element is missing.
   * 
   * @param {string} id - Element ID to update
   * @param {string} value - Value to set
   * @param {string} property - Property name ('textContent', 'innerHTML', or 'color')
   */
  function updateElement(id, value, property) {
    try {
      const element = document.getElementById(id);
      if (element) {
        if (property === 'color') {
          element.style.color = value;
        } else {
          element[property] = value;
        }
      }
    } catch (error) {
      console.error(`Error updating element ${id}:`, error);
    }
  }

  // ==========================================================================
  // Forecast Discussion (AFD) Functions
  // ==========================================================================
  
  /**
   * Quickly checks forecast discussion for winter weather indicators.
   * Used to update winter weather status before threat level calculation.
   * Only updates if alerts haven't already detected winter weather.
   * 
   * @returns {Promise<void>}
   * @private
   */
  async function checkForecastDiscussionForWinterWeather() {
    // Skip if winter weather already detected from alerts
    if (winterWeatherStatus !== 'none') {
      return;
    }

    try {
      // Quick fetch of AFD text (same logic as updateForecastDiscussion but focused)
      const indexUrl = `https://api.weather.gov/products/types/AFD/locations/${NWS_OFFICE}?limit=1`;
      let afdText = '';
      
      try {
        const idxJson = await fetchJSON(indexUrl, 8000);
        if (idxJson && typeof idxJson === 'object' && Array.isArray(idxJson.features) && idxJson.features.length > 0) {
          const feature = idxJson.features[0];
          const productUrl = feature.id || feature['@id'] || 
                           (feature.properties && (
                             feature.properties.id || 
                             feature.properties['@id'] || 
                             feature.properties.productURL || 
                             feature.properties.productURI
                           ));
          
          if (productUrl && typeof productUrl === 'string') {
            const prodJson = await fetchJSON(productUrl, 10000);
            if (prodJson && typeof prodJson === 'object') {
              afdText = prodJson.productText || 
                       (prodJson.properties && prodJson.properties.productText) || 
                       '';
            }
          }
        }
      } catch (e) {
        // Try HTML fallback
        try {
          const fallbackUrl = `https://forecast.weather.gov/product.php?site=${NWS_OFFICE}&issuedby=${NWS_OFFICE}&product=AFD&format=TXT`;
          afdText = await fetchText(fallbackUrl, 10000);
        } catch (e2) {
          // Both methods failed, skip
          return;
        }
      }

      if (afdText && afdText.trim().length > 0) {
        // Normalize and sanitize text for checking
        const normalized = afdText.replace(/\r\n|\r|\n/g, ' ').toLowerCase();
        const strippedTags = normalized.replace(/<[^>]*>/g, ' ');
        const sanitized = strippedTags.replace(/\s{2,}/g, ' ').trim();
        
        // Check for winter weather
        const winterDetected = detectWinterWeatherInText(sanitized);
        if (winterDetected.status !== 'none') {
          winterWeatherStatus = winterDetected.status;
        }
      }
    } catch (error) {
      // Silent fail - not critical for dashboard operation
      console.log('Quick winter weather check failed:', error.message);
    }
  }
  
  /**
   * Fetches and intelligently summarizes the NWS Area Forecast Discussion (AFD).
   * 
   * Uses a scoring algorithm to extract the most relevant sentences about
   * severe weather hazards. Scores sentences based on:
   * - Hazard keywords (tornado, wind, hail, flood, etc.)
   * - Severity indicators (warning, watch, enhanced risk, etc.)
   * - Timeframe relevance (today, tonight, specific days)
   * - Measurable values (wind speeds, hail sizes)
   * 
   * Displays top 3 ranked sentences, or default message if no significant weather.
   * 
   * Uses two fallback methods:
   * 1. NWS API to fetch latest AFD product
   * 2. Direct HTML scrape from forecast.weather.gov if API fails
   * 
   * @returns {Promise<void>}
   */
  async function updateForecastDiscussion() {
    try {
      const severeKeywords = [
        'severe thunderstorm', 'tornado', 'damaging wind', 'large hail', 
        'dangerous', 'warning', 'emergency', 'flash flood'
      ];

      /**
       * Attempts to fetch AFD text via NWS API with timeout protection.
       * First fetches the product index, then retrieves the full product text.
       * 
       * @returns {Promise<string>} AFD product text or empty string on failure
       * @private
       */
      async function getAFDProductText() {
        try {
          // Fetch product index with timeout protection
          const indexUrl = `https://api.weather.gov/products/types/AFD/locations/${NWS_OFFICE}?limit=1`;
          const idxJson = await fetchJSON(indexUrl, 8000);
          
          // Validate index response structure
          if (!idxJson || typeof idxJson !== 'object') {
            throw new Error('Invalid index response structure');
          }
          
          const features = idxJson.features;
          if (!Array.isArray(features) || features.length === 0) {
            throw new Error('No AFD products available');
          }
          
          const feature = features[0];
          if (!feature) {
            throw new Error('Invalid feature structure');
          }
          
          // Extract product URL from various possible locations
          const productUrl = feature.id || feature['@id'] || 
                           (feature.properties && (
                             feature.properties.id || 
                             feature.properties['@id'] || 
                             feature.properties.productURL || 
                             feature.properties.productURI
                           ));
          
          if (!productUrl || typeof productUrl !== 'string') {
            throw new Error('No product URL found in response');
          }
          
          // Fetch actual product text with timeout protection
          const prodJson = await fetchJSON(productUrl, 10000);
          
          // Extract product text from various possible locations
          if (prodJson && typeof prodJson === 'object') {
            return prodJson.productText || 
                   (prodJson.properties && prodJson.properties.productText) || 
                   '';
          }
          return '';
        } catch (e) {
          console.log(`AFD API fetch failed, will try fallback: ${e.message}`);
          return '';
        }
      }

      // Try API method first
      let afdText = await getAFDProductText();
      
      // Fallback to HTML scrape if API method fails
      if (!afdText || afdText.trim().length === 0) {
        try {
          const fallbackUrl = `https://forecast.weather.gov/product.php?site=${NWS_OFFICE}&issuedby=${NWS_OFFICE}&product=AFD&format=TXT`;
          afdText = await fetchText(fallbackUrl, 10000);
          if (!afdText || afdText.trim().length === 0) {
            afdText = '';
          }
        } catch (e) {
          console.log(`AFD HTML fallback also failed: ${e.message}`);
          afdText = '';
        }
      }

      if (!afdText) {
        updateElement('afd-content', 'No significant weather is expected.', 'innerHTML');
        return;
      }

      // Normalize line breaks and truncate at administrative section
      // (discussion content ends before watches/warnings/advisories section)
      const normalized = afdText.replace(/\r\n|\r|\n/g, ' ');
      const indexAdmin = normalized.toUpperCase().indexOf('WATCHES/WARNINGS/ADVISORIES');
      const truncated = indexAdmin !== -1 ? normalized.slice(0, indexAdmin) : normalized;
      
      // Remove HTML tags and sanitize: strip URLs, navigation elements, and boilerplate text
      const strippedTags = truncated.replace(/<[^>]*>/g, ' ');
      const sanitized = strippedTags
        .replace(/https?:\/\/\S+/gi, ' ')
        .replace(/\b(?:www\.)?weather\.gov\b/gi, ' ')
        .replace(/\bgov"?>/gi, ' ')
        .replace(/\bHOME\s+FORECAST\b/gi, ' ')
        .replace(/\bPAST\s+WEATHER\b/gi, ' ')
        .replace(/\bSAFETY\s+INFORMATION\b/gi, ' ')
        .replace(/\bEDUCATION\b/gi, ' ')
        .replace(/\bNEWS\b/gi, ' ')
        .replace(/\bSEARCH\b/gi, ' ')
        .replace(/\bToggle\s+navigation\b/gi, ' ')
        .replace(/\bUnited\s+States\s+Department\s+of\s+Commerce\b/gi, ' ')
        .replace(/\bNational\s+Weather\s+Service\b/gi, ' ')
        .replace(/\bNOAA\b/gi, ' ')
        .replace(/\b(?:png|gif|jpg|jpeg|svg)\b/gi, ' ')
        .replace(/alt=\"[^\"]*\"/gi, ' ')
        .replace(/"?\s*Wireless\s+Emergency\s+Alerts\s*"?/gi, ' ')
        .replace(/\(\s*Wireless\s+Emergency\s+Alerts\s*\)/gi, ' ')
        .replace(/\s{2,}/g, ' ')
        .trim();

      // Advanced summarization: score sentences by hazard, severity, and timeframe
      const cleanText = sanitized.toLowerCase();
      const sentences = sanitized
        .split(/(?<=[.!?])\s+/)
        .map(s => s.replace(/\s+/g, ' ').trim())
        .filter(s => s.length > 20 && s.length < 240);

      /**
       * Hazard keyword sets used for sentence scoring.
       * Each category contains terms related to specific weather hazards.
       */
      const hazardSets = {
        tornado: ['tornado', 'tornadic', 'rotation', 'wall cloud'],
        wind: ['damaging wind', 'gusts', 'straight line wind', 'microburst', 'downburst', 'wind damage'],
        hail: ['large hail', 'hailstones', 'hail up to', 'hail of'],
        thunder: ['severe thunderstorm', 'strong storms', 'severe storms', 'convection'],
        flood: ['flash flood', 'flooding', 'heavy rain', 'torrential', 'excessive rainfall'],
        winter: [
          'snow', 'snowfall', 'snowing', 'snowstorm', 'snow shower', 'snow squall',
          'freezing rain', 'freezing drizzle', 'freezing precipitation',
          'sleet', 'sleeting',
          'ice', 'icing', 'black ice', 'ice accumulation', 'ice buildup',
          'wintry', 'wintry mix', 'winter precipitation', 'winter conditions', 'winter weather',
          'accumulating snow', 'snow accumulation', 'snowfall rates', 'snow totals',
          'freezing temperatures', 'below freezing',
          'wind chill', 'windchill',
          'blizzard', 'whiteout',
          'flurries', 'wintry precipitation',
          'winter weather advisory', 'winter storm warning', 'ice storm warning',
          'blizzard warning', 'freezing rain advisory', 'snow advisory'
        ],
        heat: ['heat advisory', 'excessive heat', 'heat index'],
        cold: ['wind chill', 'hard freeze', 'freeze warning'],
        fog: ['dense fog', 'patchy fog'],
        tropical: ['tropical storm', 'hurricane', 'tropical depression']
      };
      
      /** Keywords indicating severity level in forecast discussions */
      const severityWords = ['warning', 'watch', 'advisory', 'moderate', 'enhanced', 'slight', 'marginal', 'elevated', 'high risk', 'significant', 'severe'];
      
      /** Timeframe keywords that add relevance to forecast statements */
      const timeframeWords = ['today', 'tonight', 'this afternoon', 'this evening', 'overnight', 'morning', 'afternoon', 'evening', 'weekend', 'through', 'into', 'late', 'early', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

      /**
       * Scores a sentence based on its relevance to severe weather hazards.
       * Higher scores indicate more relevant/important weather information.
       * 
       * Scoring weights:
       * - Hazard keywords: +3 points each
       * - Severity words: +2 points each
       * - Timeframe words: +1 point each
       * - Wind speeds (mph): +2 points
       * - Hail sizes (inches): +2 points
       * - Negative indicators (no significant weather): -3 points
       * - Navigation/page content: -10 points (filter out)
       * 
       * @param {string} sentence - Sentence to score
       * @returns {number} Score value (higher = more relevant)
       * @private
       */
      function scoreSentence(sentence) {
        const s = sentence.toLowerCase();
        let score = 0;
        Object.values(hazardSets).forEach(list => {
          list.forEach(k => { if (s.includes(k)) score += 3; });
        });
        severityWords.forEach(k => { if (s.includes(k)) score += 2; });
        timeframeWords.forEach(k => { if (s.includes(k)) score += 1; });
        if (/\b(\d{2,3})\s?mph\b/.test(s)) score += 2;
        if (/\b(\d(?:\.\d)?)\s?(in|inch|inches)\b/.test(s)) score += 2;
        if (/\b(\d{1,2})\s?-\s?(\d{1,2})\s?(in|inch|inches)\b/.test(s)) score += 2;
        if (/no significant|quiet pattern|benign|below normal hazards/.test(s)) score -= 3;
        if (/HOME\s+FORECAST|Toggle\s+navigation/i.test(sentence)) score = -10;
        return score;
      }

      const ranked = sentences
        .map(s => ({ s, score: scoreSentence(s) }))
        .filter(x => x.score >= 3)
        .sort((a, b) => b.score - a.score);

      const unique = [];
      const seen = new Set();
      for (const item of ranked) {
        const key = item.s.toLowerCase().replace(/[^a-z0-9]+/g, ' ').slice(0, 80);
        if (!seen.has(key)) {
          seen.add(key);
          unique.push(item.s);
        }
        if (unique.length === 3) break;
      }

      // Backup check: Update winter weather status from forecast discussion if not already set
      // (Primary check happens before threat level calculation in updateDashboard)
      if (winterWeatherStatus === 'none') {
        const winterDetected = detectWinterWeatherInText(sanitized);
        if (winterDetected.status !== 'none') {
          winterWeatherStatus = winterDetected.status;
        }
      }

      let afdContent = '';
      if (unique.length > 0) {
        afdContent = `Weather Highlights:<br>• ${unique.join('<br>• ')}`;
      } else {
        afdContent = 'No significant weather is expected.';
      }
      updateElement('afd-content', afdContent, 'innerHTML');
    } catch (error) {
      updateElement('afd-content', 'No significant weather is expected.', 'innerHTML');
    }
  }

  // ==========================================================================
  // Initialization Function
  // ==========================================================================
  
  /**
   * Initializes the dashboard and sets up periodic update intervals.
   * 
   * Sets up two update mechanisms:
   * 1. Full dashboard refresh every 15 minutes (updateInterval)
   * 2. Fast alert polling every 3 minutes (180000ms) for immediate warning updates
   * 
   * Also sets up visibilitychange listener to refresh data when page becomes visible
   * if enough time has passed since last update.
   */
  function initialize() {
    try {
      // Set up location-specific click handlers
      const alertsClickEl = document.getElementById('alamance-alerts-click');
      if (alertsClickEl) {
        alertsClickEl.onclick = () => window.open(`https://forecast.weather.gov/MapClick.php?zoneid=${NWS_ZONE}`, '_blank');
      }
      
      const afdClickEl = document.getElementById('afd-content-click');
      if (afdClickEl) {
        afdClickEl.onclick = () => window.open(`https://forecast.weather.gov/product.php?site=${NWS_OFFICE}&issuedby=${NWS_OFFICE}&product=AFD&format=CI&version=1`, '_blank');
      }
      
      // Initial load
      updateDashboard();
      
      // Regular full dashboard updates
      setInterval(updateDashboard, updateInterval);
      
      // Independent 3-minute polling for alerts to keep them fresh
      // This allows warnings and winter weather advisories to appear quickly without waiting for full refresh
      setInterval(async function() {
        try {
          const previousWinterStatus = winterWeatherStatus;
          const hadWarnings = await updateLocalAlertsAndGetStatus();
          const currentThreat = document.getElementById('threat-status')?.textContent || '';
          
          // Check if warning state has changed
          const warningStateChanged = (hadWarnings && currentThreat !== 'WARNING') || (!hadWarnings && currentThreat === 'WARNING');
          
          // Check if winter weather status has changed
          const winterStatusChanged = previousWinterStatus !== winterWeatherStatus;
          
          // Check if current threat level doesn't match the winter weather status
          const threatMismatch = (winterWeatherStatus === 'advisory' && currentThreat !== 'MONITOR') ||
                                (winterWeatherStatus === 'warning' && currentThreat !== 'WARNING') ||
                                (winterWeatherStatus === 'none' && previousWinterStatus !== 'none' && currentThreat !== 'SAFE');
          
          // Update if any of these conditions are true
          if (warningStateChanged || winterStatusChanged || threatMismatch) {
            const prevLast = lastUpdate;
            lastUpdate = 0; // force refresh
            await updateDashboard();
            lastUpdate = prevLast || Date.now();
          }
        } catch (e) {
          console.error('Alert polling error:', e);
        }
      }, 180000);
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && Date.now() - lastUpdate > updateInterval) {
          updateDashboard();
        }
      });
    } catch (error) {
      console.error('Corrected dashboard initialization error:', error);
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
})();
</script>
